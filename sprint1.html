<!DOCTYPE html>
<html>

<head>
    <title>Sprint 1</title>
    <!-- CSS for styling table and gallery items -->
    <style>
        table {
            background-color: lightgray;
            border-collapse: collapse;
            width: 100%;
            border: 2px solid black;
            /* Add this line to set the border around the table */
        }

        td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }

        .gallery-item {
            border: 1px solid black;
            padding: 10px;
            display: inline-block;
            margin: 5px;
        }

        /* Highlight the best 10% of cells in green */
        .best-10-percent {
            background-color: #00FF00;
            /* Green */
        }

        /* Highlight the worst 10% of cells in red */
        .worst-10-percent {
            background-color: #FF0000;
            /* Red */
        }
    </style>
</head>

<body>

    <!-- Dropdown for selecting the display type -->
    <label for="fileType">Choose File Type:</label>
    <select name="fileType" id="fileTypes">
        <option value="Raw"> Raw</option>
        <option value="Table"> Table</option>
        <option value="Gallery"> Gallery</option>
    </select>
    <!-- Button for standardizing-->
    <button id=" standardize" onclick="btnStandardizeOnclick()">Standardize All Numeric data</button>

    <!--Dropdonw for standardizing option-->
    <label for="fileType">Choose Standaridizing option:</label>
    <select name="ddStandrdize" id="ddStardize">
        <option value="0-10"> 0-10</option>
        <option value="1-10"> 1-10</option>
        <option value="0-1"> 0-1</option>
        <option value="-1to1">-1 - 1</option>
        <option value="Z-scores">Z-Scores</option>

    </select>
    <!-- File input to upload CSV or Excel files -->
    <input type="file" id="inputFile" accept=".csv, .xlsx, .xls">
    <pre id="csvData"></pre>
    <!-- Button to trigger data view -->
    <button id="btnView">click here to view the data</button>

    <label for="txtPk">Available key to identify an entry</label>
    <textarea name="txtPk" id="txtPk" cols="30" rows="2" disabled="true"></textarea>
    <button id="btnPK">Click here to find primary key</button>

    <!-- Dropdown for input and output -->
    <Form>
        <select id="selectedInput">
            <option>Choose Input Columns </option>
        </select>
    </Form>

    <Form>
        <select id="selectedOutput">
            <option>Choose Output Columns </option>
        </select>

    </Form>
    <button id="btnClear" onclick="clearEverything()">Click Here to Clear out the information</button>
    <br>
    <!--///////////////////////////////////////-->
    <button id="btnHiLo" onclick="hiLow()">Click here to identify what good data is</button>
    <div id="divGoodHiLow" style="display: none;">
        <p>Check the box if a high value is considered good: </p>
        <textarea name="textareaHiLow" id="taHiLow" cols="50" rows="4"></textarea>
        <div id="divCheck"></div>
    </div>

    <!-- Dropdown for selecting the column to sort -->
    <label for="sortColumn">Sort By:</label>
    <select id="sortColumn">
        <option value="">Choose Column to Sort</option>
    </select>

    <!-- Dropdown for selecting sorting order -->
    <label for="sortOrder">Order:</label>
    <select id="sortOrder">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
    </select>

    <!-- Button to trigger sort -->
    <button id="btnSort">Sort</button>

    <!-- Div to display the output -->
    <div id="output"></div>


    <!-- Including xlsx library for handling Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        document.getElementById("selectedOutput").disabled = true;
        document.getElementById("selectedInput").disabled = true;
        // Variable to hold the parsed data from the uploaded file
        let myArray;
        // Output div where the data will be displayed
        const outputDiv = document.getElementById('output');
        //2D array to store the selected input and output columns
        const selectedColumns = { input: [], output: [] };

        // Event listener for the "View Data" button
        document.getElementById("btnView").addEventListener('click', function () {
            //enable

            // Get the selected display type from the dropdown
            const selectElement = document.querySelector('#fileTypes');
            const specifiedView = selectElement.value;



            // Display data according to the selected type
            switch (specifiedView) {
                case 'Raw':
                    // Display as Raw JSON data
                    outputDiv.innerHTML = JSON.stringify(myArray, null, 2);
                    break;
                case 'Table':
                    // Display as HTML Table
                    const table = document.createElement('table');
                    for (let row of myArray) {
                        let newRow = table.insertRow();
                        for (let cell of row) {
                            let newCell = newRow.insertCell();
                            newCell.textContent = cell;
                        }
                    }
                    outputDiv.innerHTML = '';
                    outputDiv.appendChild(table);
                    break;
                case 'Gallery':
                    // Display as a gallery of divs
                    let galleryHTML = '';
                    for (let row of myArray) {
                        let item = '<div class="gallery-item">' + row.join(' | ') + '</div>';
                        galleryHTML += item;
                    }
                    outputDiv.innerHTML = galleryHTML;
                    break;
            }
        });

        // Event listener for file input change
        document.getElementById('inputFile').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const fileData = e.target.result;
                    // Handle CSV files
                    if (file.name.endsWith('.csv')) {
                        myArray = csvToArray(fileData);
                        populateDropdown("selectedInput", myArray[0]);
                        populateDropdown("selectedOutput", myArray[0]);
                    }
                    // Handle Excel files
                    else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        const workbook = XLSX.read(fileData, { type: 'binary' });
                        const firstSheet = workbook.SheetNames[0];
                        myArray = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
                        populateDropdown("selectedInput", myArray[0]);
                        populateDropdown("selectedOutput", myArray[0]);
                    }

                    populateSortDropdown(myArray[0]);
                    // Update the textarea with the parsed data
                };
                // Read the file accordingly
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.readAsBinaryString(file);
                }
            }
        });//end event Listener for inputFile
        //Event listener for input dropdown change
        document.getElementById('selectedInput').addEventListener('change', function () {
            const selectedInputIndex = this.value;
            if (selectedInputIndex !== '') {
                if (selectedColumns.output.includes(selectedInputIndex)) {
                    // column is already an output; reset the input dropdown
                    this.value = '';
                    alert("This column is already selected as an output.");
                }
                else {
                    selectedColumns.input.push(selectedInputIndex);
                    document.getElementById('selectedInput').option[selectedInputIndex].disable = true;
                    // Disable the selected input in the output dropdown
                    for (let i = 0; i < document.getElementById('selectedOutput').options.length; i++) {
                        if (i == selectedInputIndex) {
                            document.getElementById('selectedOutput').options[i].disabled = true;
                        } else {
                            document.getElementById('selectedOutput').options[i].disabled = false;
                        }
                    }
                }
            }

        });//end event Listner for selectedInput
        document.getElementById('selectedOutput').addEventListener('change', function () {
            const selectedOutputIndex = this.value;
            if (selectedOutputIndex !== '') {
                if (selectedColumns.input.includes(selectedOutputIndex)) {
                    // The selected column is already an input; reset the output dropdown
                    this.value = '';
                    alert("This column is already selected as an input.");
                }
                else {
                    selectedColumns.output.push(selectedOutputIndex);
                    document.getElementById('selectedOutput').options[selectedOutputIndex].disabled = true;
                    // Disable the selected output in the input dropdown
                    for (let i = 0; i < document.getElementById('selectedInput').options.length; i++) {
                        if (i == selectedOutputIndex) {
                            document.getElementById('selectedInput').options[i].disabled = true;
                        } else {
                            document.getElementById('selectedInput').options[i].disabled = false;
                        }
                    }
                }
            }
        });
        // Function to convert CSV data to an array
        function csvToArray(csvData) {
            const rows = csvData.split('\n');
            const result = [];
            rows.forEach(row => {
                const columns = row.split(',');
                result.push(columns);
            });
            myArray = result;
            return result;
        }
        function populateDropdown(dropdownId, data) {
            const dropdown = document.getElementById(dropdownId);
            const inputDropdown = document.getElementById("selectedInput");
            dropdown.innerHTML = "";
            data.forEach((item, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = item;
                if (dropdownId === "selectedOutput" && inputDropdown.value === index) {
                    option.disabled = true;
                }

                dropdown.add(option);
            });
            dropdown.disabled = false;
        }//end populateDropDown

        //Event listener for the primary key button. calls the function and displays the answer in the text box
        document.getElementById("btnPK").addEventListener('click', function () {
            const primaryKeyResult = findPrimaryKey(myArray);
            document.getElementById('txtPk').value = primaryKeyResult;
        });
        // The actual code to find the primary key.
        function findPrimaryKey(data) {
            if (data.length === 0) {
                return "No data available";
            }
            const firstColumn = data.map(row => row[0]);
            const uniqueValues = new Set(firstColumn);
            // checks if the column has unique data
            if (uniqueValues.size === data.length) {
                return `Primary key found: ${data[0][0]}`;
            } else {
                //if there are duplicates found in the column - we have none
                return "No primary key found";
            }
        }

        function populateSortDropdown(data) {
            const dropdown = document.getElementById("sortColumn");
            dropdown.innerHTML = "<option value=''>Choose Column to Sort</option>";
            data.forEach((item, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = item;
                dropdown.add(option);
            });
            dropdown.disabled = false;  // Enable the dropdown
        }

        document.getElementById("btnSort").addEventListener('click', function () {
            // Get the selected column index from the dropdown
            const sortIndex = parseInt(document.getElementById("sortColumn").value);

            // Get the selected sorting order from the dropdown
            const sortOrder = document.getElementById("sortOrder").value;

            // Check if a column has been selected
            if (isNaN(sortIndex)) {
                alert("Please select a column to sort.");
                return;
            }

            // Copy the header row
            const header = myArray[0];

            // Copy the data without the header row for sorting
            let sortableArray = myArray.slice(1);

            // Sort the array based on the selected column and order
            sortableArray.sort((a, b) => {
                const itemA = parseFloat(a[sortIndex]);
                const itemB = parseFloat(b[sortIndex]);

                if (isNaN(itemA) && isNaN(itemB)) {
                    // Both values are not numbers, treat them as equal
                    return 0;
                } else if (isNaN(itemA)) {
                    // itemA is not a number, place it after itemB
                    return 1;
                } else if (isNaN(itemB)) {
                    // itemB is not a number, place it after itemA
                    return -1;
                } else {
                    // Both values are numbers, perform numerical comparison
                    if (itemA < itemB) {
                        return sortOrder === "asc" ? -1 : 1;
                    } else if (itemA > itemB) {
                        return sortOrder === "asc" ? 1 : -1;
                    } else {
                        return 0;
                    }
                }
            });


            // Reconstruct the original array with the sorted data
            myArray = [header].concat(sortableArray);

            // Re-render the data
            // (Since we don't have a reusable function to render the data, I'm triggering a click event on 'btnView')
            document.getElementById("btnView").click();
        });


        //Function for standaridizing btn
        function btnStandardizeOnclick() {
            const selectedOption = document.getElementById('ddStardize').value;
            const header = myArray[0];

            let standardizable = myArray.slice(1);
            let numericColumns = [];

            // Determine which columns are numeric
            for (let j = 1; j < standardizable[0].length; j++) {
                const isNumericColumn = standardizable.every(row => !isNaN(parseFloat(row[j])));
                if (isNumericColumn) {
                    numericColumns.push(j);
                }
            }


            for (let j of numericColumns) {



                let column = standardizable.map(row => parseFloat(row[j]));
                let min = Math.min(...column);
                let max = Math.max(...column);
                const mean = column.reduce((sum, value) => sum + value, 0) / column.length;
                const squaredDifferences = column.map(value => (value - mean) ** 2);
                const variance = squaredDifferences.reduce((sum, value) => sum + value, 0) / column.length;
                const stdDev = Math.sqrt(variance);
                for (let i = 0; i < standardizable.length; i++) {

                    switch (selectedOption) {
                        case '0-10':
                            standardizable[i][j] = (((standardizable[i][j] - min) / (max - min)) * 10).toFixed(2);
                            break;
                        case '1-10':
                            standardizable[i][j] = (1 + ((standardizable[i][j] - min) / (max - min) * 9)).toFixed(2);
                            break;
                        case '0-1':
                            standardizable[i][j] = ((standardizable[i][j] - min) / (max - min)).toFixed(2);
                            break;
                        case '-1to1':
                            standardizable[i][j] = (-1 + ((standardizable[i][j] - min) / (max - min) * 2)).toFixed(2);
                            break;
                        case 'Z-scores':
                            standardizable[i][j] = ((standardizable[i][j] - mean) / stdDev).toFixed(2);
                            break;
                    }
                }

            }
            //standardizable = standardizable.map((row, rowIndex) => row.map((value, colIndex) => colIndex === j ? standardizedValue : value));



            myArray = [header].concat(standardizable);
            document.getElementById("btnView").click();
        }

        function clearEverything() {

            outputDiv.innerHTML = "";
            myArray = [];
            document.getElementById('txtPk').value = " ";
            document.getElementById("taHiLow").value = " "
            document.getElementById('divCheck').innerHTML = " ";
            document.getElementById('txtPk').value = " ";

        }

        function applyColorScaleToColumn(columnIndex, thresholds) {
            const table = document.querySelector('table');
            const rows = table.querySelectorAll('tr');

            const cellValues = [];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cellValue = parseFloat(row.cells[columnIndex].textContent);

                if (!isNaN(cellValue)) {
                    cellValues.push({ value: cellValue, row: row.cells[columnIndex] });
                }
            }

            // Sort the cell values
            cellValues.sort((a, b) => a.value - b.value);

            const totalCells = cellValues.length;
            const best10PercentIndex = Math.floor(totalCells * 0.1);
            const worst10PercentIndex = Math.floor(totalCells * 0.9);

            for (let i = 0; i < cellValues.length; i++) {
                const cellData = cellValues[i];

                if (i < best10PercentIndex) {
                    // Highlight the best 10% of cells
                    cellData.row.classList.add('best-10-percent');
                    cellData.row.classList.remove('worst-10-percent');
                } else if (i >= worst10PercentIndex) {
                    // Highlight the worst 10% of cells
                    cellData.row.classList.add('worst-10-percent');
                    cellData.row.classList.remove('best-10-percent');
                } else {
                    // Remove any previous highlighting
                    cellData.row.classList.remove('best-10-percent', 'worst-10-percent');
                }
            }
        }

        function removeColorScaleFromColumn(columnIndex) {
            const table = document.querySelector('table');
            const rows = table.querySelectorAll('tr');

            for (let i = 1; i < rows.length; i++) {
                const cell = rows[i].cells[columnIndex];
                cell.classList.remove('best-10-percent', 'worst-10-percent');
            }
        }

        function hiLow() {
            document.getElementById("divGoodHiLow").style.display = "block";
            const headers = myArray[0];
            const highGood = [];
            const highBad = [];

            // Calculate the threshold values for the best and worst 10% of cells
            const columnThresholds = {};

            for (let i = 1; i < headers.length; i++) {
                const columnValues = myArray.slice(1).map(row => parseFloat(row[i]));

                // Sort the column values
                columnValues.sort((a, b) => a - b);

                // Calculate the threshold indices for the best and worst 10%
                const totalCells = columnValues.length;
                const best10PercentIndex = Math.floor(totalCells * 0.1);
                const worst10PercentIndex = Math.floor(totalCells * 0.9);

                // Get the threshold values
                const best10PercentThreshold = columnValues[best10PercentIndex];
                const worst10PercentThreshold = columnValues[worst10PercentIndex];

                // Store the thresholds for this column
                columnThresholds[i] = {
                    best: best10PercentThreshold,
                    worst: worst10PercentThreshold
                };

                const myDiv = document.getElementById("divCheck");
                const checkbox = document.createElement('input');
                const label = document.createElement('label');

                checkbox.type = "checkbox";
                checkbox.name = "chkHighLow";
                checkbox.value = headers[i];
                checkbox.id = `chkId${i}`;

                label.htmlFor = `chkId${i}`;
                label.textContent = headers[i];
                label.name = 'labelCheck';

                myDiv.appendChild(checkbox);
                myDiv.appendChild(label);

                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        highGood.push(headers[i]);
                        const indexInHighBad = highBad.indexOf(headers[i]);
                        if (indexInHighBad !== -1) {
                            highBad.splice(indexInHighBad, 1);
                        }
                    } else {
                        highBad.push(headers[i]);
                        const indexInHighGood = highGood.indexOf(headers[i]);
                        if (indexInHighGood !== -1) {
                            highGood.splice(indexInHighGood, 1);
                        }
                    }

                    // Apply the color scale to the cells of this column if it's considered high values good
                    if (highGood.includes(headers[i])) {
                        applyColorScaleToColumn(i, columnThresholds[i]);
                    } else {
                        removeColorScaleFromColumn(i);
                    }

                    document.getElementById("taHiLow").value = highGood.join(', ');
                });
            }
        }





    </script>
</body>

</html>
